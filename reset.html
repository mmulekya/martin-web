<?php
include "db.php";

$token = $_GET['token'] ?? '';

$result = $conn->query("
  SELECT id FROM users
  WHERE reset_token='$token'
  AND reset_expire > NOW()
");

if ($result->num_rows !== 1) {
  die("Invalid or expired reset link.");
}
?>

<form method="post">
  <input type="password" name="password" placeholder="New password" required>
  <button type="submit">Reset Password</button>
</form>

<?php
if ($_SERVER["REQUEST_METHOD"] === "POST") {

  $newPassword = password_hash($_POST['password'], PASSWORD_DEFAULT);

  $conn->query("
    UPDATE users
    SET password='$newPassword',
        reset_token=NULL,
        reset_expire=NULL
    WHERE reset_token='$token'
  ");

  echo "Password changed successfully. You can now login.";
}
?>
