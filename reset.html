<?php
include "db.php";

$token = $_GET['token'] ?? '';

$stmt = $conn->prepare(
  "SELECT id FROM users WHERE reset_token=? AND reset_expire > NOW()"
);
$stmt->bind_param("s", $token);
$stmt->execute();

if ($stmt->get_result()->num_rows !== 1) {
    die("Invalid or expired link");
}

if ($_SERVER["REQUEST_METHOD"] === "POST") {

    $newPass = password_hash($_POST['password'], PASSWORD_DEFAULT);

    $stmt = $conn->prepare(
      "UPDATE users SET password=?, reset_token=NULL, reset_expire=NULL WHERE reset_token=?"
    );
    $stmt->bind_param("ss", $newPass, $token);
    $stmt->execute();

    echo "Password updated. <a href='login.php'>Login</a>";
    exit;
}
?>
<form method="post">
  <input type="password" name="password" placeholder="New password" required>
  <button>Reset password</button>
</form>
